name: FileInspectorX CI (Unified)

on:
  pull_request:
    branches: ['**']
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - '**/*.md'
      - 'Docs/**'
      - '**/*.rst'
      - '**/*.adoc'
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.gif'
      - '**/*.svg'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE*'
      - '**/README.*'
  push:
    branches: ['main','master','release/**']
    paths-ignore:
      - '**/*.md'
      - 'Docs/**'
      - '**/*.rst'
      - '**/*.adoc'
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.gif'
      - '**/*.svg'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE*'
      - '**/README.*'
  workflow_dispatch:

jobs:
  # .NET tests per-OS (tests only; build covers all TFMs on Windows including net472)
  dotnet-windows:
    name: .NET Tests (Windows)
    uses: EvotecIT/github-actions/.github/workflows/unified-ci.yml@master
    with:
      runs_on: '["windows-latest"]'
      run_tests: true
      run_pester: false
      collect_coverage: true
      summarize_failures: true
      upload_artifacts: true
      solution: 'FileInspectorX.sln'
      # Per-job PR comments disabled; consolidated summary job will handle it
      post_summary_issue: false
    secrets: inherit

  dotnet-ubuntu:
    name: .NET Tests (Ubuntu)
    uses: EvotecIT/github-actions/.github/workflows/unified-ci.yml@master
    with:
      runs_on: '["ubuntu-latest"]'
      run_tests: true
      run_pester: false
      collect_coverage: true
      summarize_failures: true
      upload_artifacts: true
      solution: 'FileInspectorX.sln'
      post_summary_issue: false
    secrets: inherit

  dotnet-macos:
    name: .NET Tests (macOS)
    uses: EvotecIT/github-actions/.github/workflows/unified-ci.yml@master
    with:
      runs_on: '["macos-latest"]'
      run_tests: true
      run_pester: false
      collect_coverage: true
      summarize_failures: true
      upload_artifacts: true
      solution: 'FileInspectorX.sln'
      post_summary_issue: false
    secrets: inherit

  # PowerShell tests as a separate job (Windows-only to include PS 5.1 and PS 7)
  pester-windows:
    name: PowerShell Tests (Windows 5.1/7)
    uses: EvotecIT/github-actions/.github/workflows/unified-ci.yml@master
    with:
      runs_on: '["windows-latest"]'
      # Build the solution to produce the binary module used by the PS module
      solution: 'FileInspectorX.sln'
      run_tests: false
      run_pester: true
      ps_versions: '["5.1","7"]'
      # If you keep your tests elsewhere, point explicitly:
      test_script: 'Module/FileInspectorX.Tests.ps1'
      collect_coverage: false
      summarize_failures: true
      upload_artifacts: true
      post_summary_issue: false
    secrets: inherit

  # PR-only Claude review (uses dedicated reusable). No-op on push.
  claude-review:
    if: ${{ github.event_name == 'pull_request' }}
    name: Claude Code Review
    uses: evotecit/github-actions/.github/workflows/review-claude.yml@master
    with:
      runs_on: '["ubuntu-latest"]'
      # model: ''            # optional override, e.g. 'claude-3-5-sonnet'
      # direct_prompt: ''    # optional custom prompt
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  # Aggregate failing-tests summary across all jobs and post one sticky PR comment
  summary:
    name: Consolidated Test Summary
    needs: [dotnet-windows, dotnet-ubuntu, dotnet-macos, pester-windows]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download TRX artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: trx-*
          path: artifacts
          merge-multiple: true

      - name: Download Pester results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-ps*
          path: artifacts
          merge-multiple: true

      - name: Aggregate failing tests
        id: aggregate
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $root = Join-Path $PWD 'artifacts'
          if (-not (Test-Path $root)) { New-Item -ItemType Directory -Force -Path $root | Out-Null }

          $md = "## CI Failing Tests Summary`n`n"
          $failed = 0

          # .NET TRX parsing
          $trxFiles = Get-ChildItem -Recurse -Path $root -Filter *.trx -ErrorAction SilentlyContinue
          if ($trxFiles) {
            $md += "### .NET`n"
            foreach ($trx in $trxFiles) {
              try {
                $nodes = Select-Xml -Path $trx.FullName -XPath "//UnitTestResult[@outcome='Failed']"
                $groupTitle = [System.IO.Path]::GetFileNameWithoutExtension($trx.Name)
                $printed = $false
                foreach ($n in $nodes) {
                  if (-not $printed) { $md += "#### $groupTitle`n"; $printed = $true }
                  $name = $n.Node.testName
                  $msg  = $n.Node.Output.ErrorInfo.Message
                  $md += "- ❌ $name`n"
                  if ($msg) { $md += "  - $msg`n" }
                  $failed++
                }
              } catch { }
            }
          }

          # Pester NUnit XML parsing
          $nunitFiles = Get-ChildItem -Recurse -Path $root -Filter TestResults.xml -ErrorAction SilentlyContinue
          if ($nunitFiles) {
            $md += "### PowerShell (Pester)`n"
            foreach ($xmlPath in $nunitFiles) {
              try {
                [xml]$xml = Get-Content -LiteralPath $xmlPath.FullName
                $cases = $xml.SelectNodes('//test-case')
                $groupTitle = Split-Path -Leaf -Path (Split-Path -Parent -Path $xmlPath.FullName)
                $printed = $false
                foreach ($c in $cases) {
                  if ($c.result -in @('Failure','Error')) {
                    if (-not $printed) { $md += "#### $groupTitle`n"; $printed = $true }
                    $name = $c.name
                    $msg = $c.failure.message.'#text'
                    $md += "- ❌ $name`n"
                    if ($msg) { $md += "  - $msg`n" }
                    $failed++
                  }
                }
              } catch { }
            }
          }

          if ($failed -eq 0) { $md += "All tests passed ✅`n" }

          if ($env:GITHUB_STEP_SUMMARY) { $md | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append }
          "markdown<<EOF`n$md`nEOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "hasfailures=$([string]([bool]($failed -gt 0)))" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Post consolidated PR comment
        if: ${{ github.event_name == 'pull_request' && steps.aggregate.outputs.hasfailures == 'true' }}
        uses: actions/github-script@v7
        env:
          SUMMARY_MARKER: evotec-ci-aggregate-summary
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;
            const marker = `<!-- ${process.env.SUMMARY_MARKER} -->`;
            const md = `${{ toJSON(steps.aggregate.outputs.markdown) }}`;
            const sticky = true;
            const comments = await github.paginate(github.rest.issues.listComments, {owner, repo, issue_number, per_page: 100});
            const found = comments.find(c => typeof c.body === 'string' && c.body.includes(marker));
            const body = `${marker}\n${md}`;
            if (found && sticky) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: found.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
